From bca9dd8e2a8d0076a45bfbe7b43cfea546c4b244 Mon Sep 17 00:00:00 2001
From: Karol Lewandowski <k.lewandowsk@samsung.com>
Date: Fri, 7 Dec 2012 12:30:51 +0100
Subject: [PATCH] Add systemd service and socket files for user session.

  + Introduce necessary modification to the spec file.
  + Add other required patches.

user-session files are original work of Patrick McCarty
<patrick.mccarty@linux.intel.com>

Signed-off-by: ≈Åukasz Stelmach <l.stelmach@samsung.com>
[ provide both old and new/modified system.conf for sysvinit to systemd transition period ]
Signed-off-by: Karol Lewandowsk <k.lewandowsk@samsung.com>

Change-Id: I61eee2ef0e1cd7fbd2ad3aa5893eccc1a7792651

---
 .../0003-dbus_service_highest_prio_setting.patch   |   14 +++++
 packaging/dbus-user.service                        |   14 +++++
 packaging/dbus-user.socket                         |   11 ++++
 packaging/dbus.spec                                |   62 ++++++++++++--------
 packaging/slp-add-services-directory.patch         |   12 ++++
 packaging/slp-relax-permissions.patch              |   15 +++++
 6 files changed, 105 insertions(+), 23 deletions(-)
 create mode 100644 packaging/0003-dbus_service_highest_prio_setting.patch
 create mode 100644 packaging/dbus-user.service
 create mode 100644 packaging/dbus-user.socket
 create mode 100644 packaging/slp-add-services-directory.patch
 create mode 100644 packaging/slp-relax-permissions.patch

diff --git a/packaging/0003-dbus_service_highest_prio_setting.patch b/packaging/0003-dbus_service_highest_prio_setting.patch
new file mode 100644
index 0000000..f486893
--- /dev/null
+++ b/packaging/0003-dbus_service_highest_prio_setting.patch
@@ -0,0 +1,14 @@
+diff -uNrp dbus-1.5.10/bus/dbus.service.in dbus-1.5.10.patched//bus/dbus.service.in
+--- dbus-1.5.10/bus/dbus.service.in	2012-02-20 03:31:57.000000000 -0800
++++ dbus-1.5.10.patched//bus/dbus.service.in	2012-05-16 13:53:34.693898389 -0700
+@@ -3,6 +3,10 @@ Description=D-Bus System Message Bus
+ Requires=dbus.socket
+ After=syslog.target
+ 
++IOSchedulingClass=realtime
++IOSchedulingPriority=0
++CPUSchedulingPriority=99
++
+ [Service]
+ ExecStart=@EXPANDED_BINDIR@/dbus-daemon --system --address=systemd: --nofork --nopidfile --systemd-activation
+ ExecReload=@EXPANDED_BINDIR@/dbus-send --print-reply --system --type=method_call --dest=org.freedesktop.DBus / org.freedesktop.DBus.ReloadConfig
diff --git a/packaging/dbus-user.service b/packaging/dbus-user.service
new file mode 100644
index 0000000..ff9ba4a
--- /dev/null
+++ b/packaging/dbus-user.service
@@ -0,0 +1,14 @@
+
+#
+# This is the D-Bus service for the session
+#
+
+[Unit]
+Description=D-Bus Session Message Bus
+Requires=dbus.socket
+
+[Service]
+ExecStart=/usr/bin/dbus-daemon --session --address=systemd: --nofork --systemd-activation
+ExecReload=/usr/bin/dbus-send --print-reply --session --type=method_call --dest=org.freedesktop.DBus / org.freedesktop.DBus.ReloadConfig
+OOMScoreAdjust=-850
+
diff --git a/packaging/dbus-user.socket b/packaging/dbus-user.socket
new file mode 100644
index 0000000..8a12c49
--- /dev/null
+++ b/packaging/dbus-user.socket
@@ -0,0 +1,11 @@
+
+#
+# This is the D-Bus socket for the session bus
+#
+
+[Unit]
+Description=D-Bus Session Message Bus Socket
+
+[Socket]
+ListenStream=%t/dbus/user_bus_socket
+
diff --git a/packaging/dbus.spec b/packaging/dbus.spec
index d3bcdb5..c9622ea 100755
--- a/packaging/dbus.spec
+++ b/packaging/dbus.spec
@@ -7,15 +7,22 @@ License:	GPLv2+ or AFL
 URL:		http://www.freedesktop.org/software/dbus/
 Source0:	http://dbus.freedesktop.org/releases/%{name}/%{name}-%{version}.tar.gz
 Source1:	dbus-daemon_run
-Source2:	system.conf
+Source2:	dbus-user.socket
+Source3:	dbus-user.service
+Source4:	system.conf
 Source1001:	dbus.manifest
 Patch1:         0001-Enable-checking-of-smack-context-from-DBus-interface.patch
 Patch2:         0002-Enforce-smack-policy-from-conf-file.patch
+Patch3:         0003-dbus_service_highest_prio_setting.patch
+Patch4:         slp-relax-permissions.patch
+Patch5:         slp-add-services-directory.patch
 Requires:	%{name}-libs = %{version}
 BuildRequires:  expat-devel >= 1.95.5
 BuildRequires:  libtool
 BuildRequires:  libx11-devel
 BuildRequires:  pkgconfig(libsmack)
+BuildRequires:  pkgconfig(libsystemd-daemon)
+BuildRequires:  pkgconfig(libsystemd-login)
 
 
 %description
@@ -27,6 +34,8 @@ messaging facility.
 %package libs
 Summary:    Libraries for accessing D-Bus
 Group:      System/Libraries
+#FIXME: This is circular dependency
+Requires:   %{name} = %{version}-%{release}
 Requires(post): /sbin/ldconfig
 Requires(postun): /sbin/ldconfig
 
@@ -46,11 +55,14 @@ Headers and static libraries for D-Bus.
 %setup -q -n %{name}-%{version}
 %patch1 -p1
 %patch2 -p1
+%patch3 -p1
+%patch4 -p1
+%patch5 -p1
 
 %build
 cp %{SOURCE1001} .
-CFLAGS="$CFLAGS -DUSE_MONOTONIC"
-LDFLAGS="$LDFLAGS -lrt"
+#CFLAGS="$CFLAGS -DUSE_MONOTONIC"
+#LDFLAGS="$LDFLAGS -lrt"
 
 %reconfigure --disable-static \
     --exec-prefix=/ \
@@ -64,31 +76,37 @@ LDFLAGS="$LDFLAGS -lrt"
     --disable-libaudit \
     --enable-tests=no \
     --with-system-pid-file=%{_localstatedir}/run/messagebus.pid \
-    --with-dbus-user=root \
+    --with-dbus-user=dbus \
     --with-systemdsystemunitdir=%{_libdir}/systemd/system \
     --enable-smack \
 
 make %{?jobs:-j%jobs}
 
 %install
-rm -rf %{buildroot}
 %make_install
-
 %remove_docs
 
-mkdir -p %{buildroot}/etc/rc.d/init.d
-mkdir -p %{buildroot}/etc/rc.d/rc{3,4}.d
-mkdir -p %{buildroot}/usr/etc/dbus-1
-cp %{SOURCE1} %{buildroot}/etc/rc.d/init.d/dbus-daemon_run
-cp %{SOURCE2} %{buildroot}/etc/dbus-1/system.conf
-chmod 755 %{buildroot}/etc/rc.d/init.d/dbus-daemon_run
-ln -s ../init.d/dbus-daemon_run  %{buildroot}/etc/rc.d/rc3.d/S04dbus-daemon_run
-ln -s ../init.d/dbus-daemon_run %{buildroot}/etc/rc.d/rc4.d/S04dbus-daemon_run
+mv %{buildroot}/etc/dbus-1/system.conf %{buildroot}/etc/dbus-1/system.conf.systemd
+install -m644 %{SOURCE4} %{buildroot}/etc/dbus-1/system.conf
+
+mkdir -p %{buildroot}%{_libdir}/pkgconfig
+# Change the arch-deps.h include directory to /usr/lib instead of /lib
+sed -e 's@-I${libdir}@-I${prefix}/%{_lib}@' %{buildroot}%{_libdir}/pkgconfig/dbus-1.pc
 
 mkdir -p %{buildroot}%{_datadir}/dbus-1/interfaces
 
 ln -s dbus.service %{buildroot}%{_libdir}/systemd/system/messagebus.service
 
+mkdir -p %{buildroot}%{_libdir}/systemd/user
+install -m0644 %{SOURCE2} %{buildroot}%{_libdir}/systemd/user/dbus.socket
+install -m0644 %{SOURCE3} %{buildroot}%{_libdir}/systemd/user/dbus.service
+
+mkdir -p %{buildroot}%{_sysconfdir}/rc.d/init.d
+mkdir -p %{buildroot}%{_sysconfdir}/rc.d/rc{3,4}.d
+install -m0755 %{SOURCE1} %{buildroot}%{_sysconfdir}/rc.d/init.d/dbus-daemon_run
+ln -s ../init.d/dbus-daemon_run %{buildroot}%{_sysconfdir}/rc.d/rc3.d/S30dbus-daemon_run
+ln -s ../init.d/dbus-daemon_run %{buildroot}%{_sysconfdir}/rc.d/rc4.d/S30dbus-daemon_run
+
 mkdir -p $RPM_BUILD_ROOT%{_datadir}/license
 for keyword in LICENSE COPYING COPYRIGHT;
 do
@@ -102,14 +120,13 @@ done
 %post
 mkdir -p /opt/var/lib/dbus
 
-
 %post libs
 /sbin/ldconfig
 
+%post libs -p /sbin/ldconfig
 
 %postun libs -p /sbin/ldconfig
 
-
 %files
 %manifest dbus.manifest
 %{_datadir}/license/%{name}
@@ -125,26 +142,25 @@ mkdir -p /opt/var/lib/dbus
 %config(noreplace) %{_sysconfdir}/dbus-1/session.conf
 %dir %{_sysconfdir}/dbus-1/session.d
 %config(noreplace) %{_sysconfdir}/dbus-1/system.conf
+%config(noreplace) %{_sysconfdir}/dbus-1/system.conf.systemd
 %dir %{_sysconfdir}/dbus-1/system.d
 %dir %{_libdir}/dbus-1
 %attr(4750,root,dbus) %{_libdir}/dbus-1/dbus-daemon-launch-helper
-%{_libdir}/systemd/system/dbus.service
-%{_libdir}/systemd/system/dbus.socket
-%{_libdir}/systemd/system/dbus.target.wants/dbus.socket
-%{_libdir}/systemd/system/messagebus.service
-%{_libdir}/systemd/system/multi-user.target.wants/dbus.service
-%{_libdir}/systemd/system/sockets.target.wants/dbus.socket
+%{_libdir}/systemd/system/*
+%{_libdir}/systemd/user/*
 %dir %{_datadir}/dbus-1
+%{_datadir}/dbus-1/interfaces
 %{_datadir}/dbus-1/services
 %{_datadir}/dbus-1/system-services
-%{_datadir}/dbus-1/interfaces
 %dir %{_localstatedir}/run/dbus
 %dir %{_localstatedir}/lib/dbus
 
 %files libs
+%manifest dbus.manifest
 %{_libdir}/libdbus-1.so.3*
 
 %files devel
+%manifest dbus.manifest
 %{_libdir}/libdbus-1.so
 %{_includedir}/dbus-1.0/dbus/dbus*.h
 %dir %{_libdir}/dbus-1.0
diff --git a/packaging/slp-add-services-directory.patch b/packaging/slp-add-services-directory.patch
new file mode 100644
index 0000000..52ccd99
--- /dev/null
+++ b/packaging/slp-add-services-directory.patch
@@ -0,0 +1,12 @@
+--- dbus/bus/system.conf.in.orig	2012-08-30 22:34:59.217764232 +0900
++++ dbus/bus/system.conf.in	2012-08-31 15:45:29.521756849 +0900
+@@ -23,6 +23,9 @@
+   <!-- We use system service launching using a helper -->
+   <standard_system_servicedirs/>
+ 
++  <!-- SLP services used to be installed under following location -->
++  <servicedir>/usr/share/dbus-1/services</servicedir>
++
+   <!-- This is a setuid helper that is used to launch system services -->
+   <servicehelper>@DBUS_LIBEXECDIR@/dbus-daemon-launch-helper</servicehelper>
+ 
diff --git a/packaging/slp-relax-permissions.patch b/packaging/slp-relax-permissions.patch
new file mode 100644
index 0000000..578025f
--- /dev/null
+++ b/packaging/slp-relax-permissions.patch
@@ -0,0 +1,15 @@
+--- dbus/bus/system.conf.in.orig	2012-08-30 22:34:59.217764232 +0900
++++ dbus/bus/system.conf.in	2012-08-30 22:41:16.033764186 +0900
+@@ -45,10 +45,8 @@
+     <!-- All users can connect to system bus -->
+     <allow user="*"/>
+ 
+-    <!-- Holes must be punched in service configuration files for
+-         name ownership and sending method calls -->
+-    <deny own="*"/>
+-    <deny send_type="method_call"/>
++    <allow own="*"/>
++    <allow send_type="method_call"/>
+ 
+     <!-- Signals and reply messages (method returns, errors) are allowed
+          by default -->
-- 
1.7.10.4

